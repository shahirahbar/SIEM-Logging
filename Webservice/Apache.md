## Apache Log Configuration

To configure logging for the Apache web server, open the `httpd.conf` file located in the `/etc/apache/conf/` directory.

**Note:** The path to the `httpd.conf` file may vary depending on the Linux distribution.

**Note:** In different versions of Apache, there may be other primary configuration files such as `apache2.conf` or `apache.conf` instead of `httpd.conf`.

To configure the log format, open the file with a suitable editor and apply the following changes:

```apache
LogFormat "%v:%p %h %d %u %t \"%r\" %>s %O \"%(Referer)N\" \"%(User-Agent)N"" whost_combined
LogFormat "%h %d %u %t \"%r\" %>s %O \"%(Referer)N\" \"%(User-Agent)N"" combined
LogFormat "%h %d %u %t \"%r\" %>s %O" common
LogFormat "%(Referer)I -> %U" referer
LogFormat "%(User-agent)I" agent
LogFormat "%(%s)t %d %O \"%(Cookie)N" %v %p \"%(Content-type)N\" \"%m\" \"%(Referer)N\" \"%(User-agent)N"
\"%l\" %D %h %>s \"%U\" \"%q\" \"%u\""" aplc_csv
```
-------------------------
### Virtual Host Configuration
```
<VirtualHost *:80>
    # The ServerName directive sets the request scheme, hostname, and port that
    # the server uses to identify itself. This is used when creating
    # redirection URLs. In the context of virtual hosts, the ServerName
    # specifies what hostname must appear in the request's Host: header to
    # match this Virtual host. For the default virtual host (this file) this
    # value is not decisive as it is used as a last resort host regardless.
    # However, you must set it for any further virtual host explicitly.
    #ServerName www.example.com

    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html

    # Available loglevels: traces, ..., tracel, debug, info, notice, warn,
    # error, crit, alert, emerg,
    # It is also possible to configure the loglevel for particular
    # modules, e.g.
    #LogLevel info ssl:warn

    ErrorLog ${APACHE_LOG_DIR}/error.log
    CustomLog ${APACHE_LOG_DIR}/access.log aplc_csv

    # For most configuration files from conf-available/, which are
    # enabled or disabled at a global level, it is possible to
    # include a line for only one particular virtual host. For example the
    # following line enables the CGI configuration for this host only
    # after it has been globally disabled with "azdisconf".
    #Include conf-available/serve-cgi-bin.conf
</VirtualHost>
```
(These settings should be applied for each website created in Apache.)

To check the syntax of the new configuration, use the following command: 

```
# apachectl configtest
 ```

(The output of the above command should be OK.)

Then, restart the Apache service to apply the new configuration.

----------------------------------------------------------------

At this stage, you can check the log path to ensure that logs are generated according to the applied format. The logs generated by Apache can be read from the relevant file and sent to the SIEM using the rsyslog service and the imfile module. (Note that the rsyslog tool is available by default on most Linux distributions.)

By default, Apache2 logs are stored in two files: access.log and error.log.

To send logs, open the configuration file located at:

/etc/rsyslog.conf

Add the following lines to the end of the file to send logs to the specified log collector:
```
module(load="imfile" PollingInterval="1")

input(type="imfile" File="/var/log/apache2/access.log" Tag="apache_access" Severity="warn" Facility="local6")

input(type="imfile" File="/var/log/apache2/error.log" Tag="apache_error" Severity="warn" Facility="local6")

local6.* @<log colector ip>:<optional port>
```
Then, restart the rsyslog service.

To ensure that logs are being sent, use tcpdump on the Log collector machine with the destination port (optional port) and the source host IP of the Apache server:
```
# tcpdump –n –i any dst port <optional port> and host <Apache_server_IP> -A
```
-------------------------------------------------------------

### Installation Checklist
1. Log in to the system as a user with full root access.
2. Ensure that the date, time, and timezone are correctly set on the operating system. If necessary, sync the system with an internal NTP server or manually set the date and time based on the timezone: Your location.
3. Configure the Apache configuration files as described in this document.
4. Check the syntax of the configuration file using the commands provided in this document.
5. Restart the Apache service to apply the configurations.
6. Verify that logs are being generated in the /var/log/apache2/access.log path.
7. Check the generated Apache logs to ensure they match the expected format based on the configurations.
8. Use the rsyslog service and the imfile module to send logs as described in this document.
9. Restart the rsyslog service to apply the configurations.
10. Run the tcpdump command on the SF or <log collector> machine with the destination port <optional port>/UDP to ensure that Apache logs are being received from the Apache server:

```
tcpdump –n –i any dst port <optional port> and host <apache_server_IP> -A
```
Replace <apache_server_IP> with the IP address of the Apache server.

11. To ensure that rsyslog is functioning correctly and sending logs to the SIEM, you can use the following tcpdump command on the Apache server:
```
tcpdump –n –i any dst port <optioanl port> and host <Log_colector_server_IP> -A
```
Replace <Log_colector_server_IP> with the IP address of the Log colector server.

12. If the Apache server is sending logs (based on the process in step 10) but the Log colector machine is not receiving them (based on the checklist in step 9), it may indicate a routing issue or a blocked connection by an intermediary firewall.
